<!DOCTYPE html>
<html>
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
  
  <title>多年后终于（开始）完成的夙愿——2048 | This is oziroe.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="嗯，我想写一个2048已经好久好久了……  人蠢是一种怎样的体验？连个2048都不会写。">
<meta name="keywords" content="javascript,2048,Try2048,函数式编程">
<meta property="og:type" content="article">
<meta property="og:title" content="多年后终于（开始）完成的夙愿——2048">
<meta property="og:url" content="https://oziroe.github.io/2017/08/01/多年后终于（开始）完成的夙愿——2048/index.html">
<meta property="og:site_name" content="This is oziroe.">
<meta property="og:description" content="嗯，我想写一个2048已经好久好久了……  人蠢是一种怎样的体验？连个2048都不会写。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://oziroe.github.io/images/2048运行截图.png">
<meta property="og:updated_time" content="2017-08-07T10:19:21.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="多年后终于（开始）完成的夙愿——2048">
<meta name="twitter:description" content="嗯，我想写一个2048已经好久好久了……  人蠢是一种怎样的体验？连个2048都不会写。">
<meta name="twitter:image" content="https://oziroe.github.io/images/2048运行截图.png">
  
    <link rel="alternate" href="/atom.xml" title="This is oziroe." type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

  <meta name="baidu-site-verification" content="mocJIK9AF5" /><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">This is oziroe.</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Please call me cowsay.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://oziroe.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-多年后终于（开始）完成的夙愿——2048" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/01/多年后终于（开始）完成的夙愿——2048/" class="article-date">
  <time datetime="2017-07-31T21:35:59.000Z" itemprop="datePublished">2017-08-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      多年后终于（开始）完成的夙愿——2048
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>嗯，我想写一个2048已经好久好久了……</p>
<blockquote>
<p>人蠢是一种怎样的体验？<br>连个2048都不会写。</p>
</blockquote>
<p><img src="/images/2048运行截图.png" alt="懒得上色的2048"></p>
<a id="more"></a>
<p>当然啦，我说的2048一定是指带动画的版本，静态的我早就写过了。“写个动画有什么难的？”我在动手写之前也是这么想的，后来发现这背后的问题大了……不过在此之前，我们先明确一下2048的规则。</p>
<h1 id="一群2们究竟是怎么合成一个2048的"><a href="#一群2们究竟是怎么合成一个2048的" class="headerlink" title="一群2们究竟是怎么合成一个2048的"></a>一群2们究竟是怎么合成一个2048的</h1><p>一个简单的问题：一行四个2，为什么合成的是两个4，不是一个8或者一个4+两个2？</p>
<p>在2048中，一次滑动之后，要经过以下的步骤：</p>
<ol>
<li>按照滑动的方向把数字分为四列，每列之间互不干涉。</li>
<li>按照滑动的方向把各数字标号，手指轨迹指向的方向为“大端”，从大端开始分别标号为1，2，3，4。</li>
<li>从2号数字开始，称为当前数字，执行以下的步骤<ol>
<li>查看当前数字前面的一个位置；</li>
<li>若该位置被标记为“已合并”，则当前数字停在该位置之后的一个位置上；</li>
<li>若该位置上有数字，则若该数字与当前数字一样，就将当前数字合并到该位置上，并将该位置标记为“已合并”；否则，将当前数字移动到该位置之后的一个位置上；</li>
<li>若该位置没有数字，则继续看该位置之前的一个位置，并重复以上步骤；若一直看到1号位置都没有数字，则将当前数字移动到1号位置上。</li>
</ol>
</li>
</ol>
<p>以上的步骤对每列的数字顺次执行，即前一个数字操作完了后一个数字再开始，当所有数字都操作完时这次滑动的效果全部完成。如果在整个过程中没有任何一个数字的位置或大小发生变化，则认为这是一个无效操作；否则在空格区域随机添加一个数字，位置完全随机，数字有十分之一的概率是4，其余是2。开局的两个数字与此一致。</p>
<hr>
<p>经过上面的一番长篇大论，大致可以看出，操作的基本单位是数字，而基本操作有三种：移动，合并和新增。其中合并是指一个数字不动，另一个数字移动到其位置与之合并，该操作又可以分为两步：先移动，然后目的地的数字替换为加倍的数字。为什么要把合并拆开看？仔细观察2048游戏界面就会发现，每次滑动过后的动画，是按照移动、合并和新增的顺序进行的，只有所有的移动动画全部结束以后（无论是单纯的移动还是合并的前半部分），才会开始合并的动画。到这里，为什么动画难实现的回答也有了一半：所有的操作不能按照算法的顺序直接作用在局面上，要先存起来，整理好顺序才能执行。</p>
<p>而另一半原因则是这三种操作本身的区别：移动和替换都是针对一个数字，而新增则是从无到有；移动时，两个数字可能会移动到同一个位置上。按照一般的思路……算了我已经把一般的思路忘得差不多了。接下来就是Try2048登场的时间了。</p>
<hr>
<p>相比起2048的“官方”<a href="https://github.com/gabrielecirulli/2048" target="_blank" rel="external">实现</a>，这应该算是一个超级短小的程序，目前还没有500行，因此没有分散在多个文件里，预期就是让读者可以一口气看到低——记得当初实在写不出去看官方版本的时候，还没有看懂那些现在看来连设计模式都算不上的封装就已经被吓跑了，真是怀念啊。写代码的思路基本是分层，然后由下至上的实现，因此本文也采取这样的顺序。</p>
<p>最底层并不是画界面，我认为这个层面可以慢慢写，所以首先抽象了三个基本操作：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Advent</span>(<span class="params">x, y, number, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Number "</span> + number + <span class="string">" appears at "</span> + StringP(x, y));</div><div class="line">    DisplayAdvent(x, y, number, finished);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Move</span>(<span class="params">x, y, newX, newY, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"The number at "</span> + StringP(x, y) + <span class="string">" is now at "</span> +</div><div class="line">        StringP(newX, newY));</div><div class="line">    DisplayMove(x, y, newX, newY, finished);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Substitute</span>(<span class="params">x, y, number, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"The number at "</span> + StringP(x, y) + <span class="string">" is now changed to "</span> +</div><div class="line">        number);</div><div class="line">    DisplaySubstitute(x, y, number, finished);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样做之后给自己带来了一些小小的麻烦，下文中会详细讲到。可以看到，函数体原本只有一行log，后来写好了底层才对接了上来。接受的参数中<code>finished</code>是一个不带参数的回调函数，调用它即意味着当前基本操作完成了。是的，这些接口都会在动画执行之前就返回，因此需要这个参数确定确切的完成时间。原本只打印log的时候<code>finished</code>就直接就地调用了，现在则需要传下去。</p>
<p>有了基本操作的表示以后，进入到最复杂也是最重要的一个抽象层次：<code>Turn</code>。它代表着一次滑动所触发的所有基本操作的集合，对上层提供的接口除了向集合中添加基本操作外，还有一个<code>Trigger</code>函数，在执行时会按照上文所述的顺序执行所有的基本操作，并且等待一类基本操作都执行完了再执行下一类，它还可以携带一些钩子函数，在合适的时机触发它们。首先是内部数据结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Turn</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">this</span>._actions = &#123;<span class="attr">advent</span>: [], <span class="attr">move</span>: [], <span class="attr">substitute</span>: []&#125;;</div><div class="line">    <span class="keyword">this</span>._remain  = &#123;<span class="attr">advent</span>: <span class="number">0</span>, <span class="attr">move</span>: <span class="number">0</span>, <span class="attr">substitute</span>: <span class="number">0</span>&#125;;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中<code>_actions</code>存了每种基本操作的每一个操作的调用参数，比如<code>advent</code>中的元素形式为<code>{x, y, number}</code>，与上面的接口相对应，而<code>_remain</code>中则是每种基本操作的剩余个数。</p>
<p>接下来是向<code>Turn</code>中添加操作的接口：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.Advent = <span class="function"><span class="keyword">function</span>(<span class="params">x, y, number</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    self._remain.advent++;</div><div class="line">    self._actions.advent.push(&#123;<span class="attr">x</span>: x, <span class="attr">y</span>: y, <span class="attr">number</span>: number&#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">this</span>.Move = <span class="function"><span class="keyword">function</span>(<span class="params">x, y, newX, newY</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    self._remain.move++;</div><div class="line">    self._actions.move.push(&#123;<span class="attr">x1</span>: x, <span class="attr">y1</span>: y, <span class="attr">x2</span>: newX, <span class="attr">y2</span>: newY&#125;);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">this</span>.Merge = <span class="function"><span class="keyword">function</span>(<span class="params">x, y, toX, toY, number</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    self.Move(x, y, toX, toY);</div><div class="line">    self._remain.substitute++;</div><div class="line">    self._actions.substitute.push(&#123;<span class="attr">x</span>: toX, <span class="attr">y</span>: toY, <span class="attr">number</span>: number * <span class="number">2</span>&#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中，<code>Merge</code>在该层被抽象出来，上层将可以使用真正需要的三个接口进行调用。接下来的<code>Trigger</code>函数……做好心理准备：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.Trigger = <span class="function"><span class="keyword">function</span>(<span class="params">afterMove=null, afterAdvent=null</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">CommonPatternHere</span>(<span class="params">dataSet, call, decrease, beforeNext,</span></span></div><div class="line"><span class="function"><span class="params">        after</span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">if</span> (dataSet.length === <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                after();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">while</span> (dataSet.length &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">var</span> data = dataSet.pop();</div><div class="line">                call(data, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line"><span class="function">                </span>&#123;</div><div class="line">                    <span class="comment">// It is heard that in Javascript there's no data race.</span></div><div class="line">                    <span class="comment">// The following code need fix if I was wrong.</span></div><div class="line">                    <span class="comment">// `decrease` will change count value and return its new</span></div><div class="line">                    <span class="comment">// value. It must be wrapped to change the origin var.</span></div><div class="line">                    <span class="keyword">if</span> (decrease() === <span class="number">0</span>)</div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">if</span> (beforeNext !== <span class="literal">null</span>)</div><div class="line">                            beforeNext();</div><div class="line">                        after();</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上是该函数的第一部分。由于对于三种基本操作的处理方法基本一致，因此抽象出一个pattern。整个思路还算清晰，有点别扭的大概就是上面的<code>decrease</code>了，这是因为原本调用是用的<code>self._remain.advent</code>之类，后来发现不行，因此基本类型是传值调用的，于是改成<code>{value: self._remain.advent}</code>，结果还是不行，因为保留更改的只是这个匿名对象里的值，而从<code>self._remain.advent</code>到这个匿名对象还是复制了……所以接下来如果看到这种东西：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> --self._remain.advent; &#125;</div></pre></td></tr></table></figure>
<p>希望你能体会我的无奈。</p>
<p>哦你说为啥参数里没有<code>afterMerge</code>？这不是赤裸裸的歧视吗？一方面我还没想好怎么把它对接到替换上去，另一方面……其实这俩也是因为用上了才慢慢加上的，<code>afterMerge</code>？没有这种需求，当然就没有啦。</p>
<p>看完第一部分我想你已经猜到了接下来怎么调用它，不过也许你发现了一些不得了的东西：为什么这个函数要返回一个匿名函数？这不是多此一举吗？如果我告诉你这是为了保持和<code>after</code>参数形式的一致性，我想你大概能预感到一些可怕的事情了。没错，我遵循那个著名的信条：</p>
<blockquote>
<p>嵌套回调函数是丑陋的。</p>
</blockquote>
<p>原话大概还包含了对其的一个形象的比喻，不过被我忘记了。总之，作为嵌套回调转化为链式的准备步骤，就有了接下来的第二部分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">CurryList</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">this</span>._list = [];</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">this</span>.Call = <span class="function"><span class="keyword">function</span>(<span class="params">dataSet, call, decrease,</span></span></div><div class="line"><span class="function"><span class="params">        beforeNext=null</span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        self._list.push(&#123;<span class="attr">dataSet</span>: dataSet, <span class="attr">call</span>: call,</div><div class="line">            decrease: decrease, <span class="attr">beforeNext</span>: beforeNext&#125;);</div><div class="line">        <span class="keyword">return</span> self;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">this</span>.List = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> self._list.map(<span class="function"><span class="keyword">function</span>(<span class="params">argument</span>)</span></div><div class="line"><span class="function">        </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">after</span>)</span></div><div class="line"><span class="function">            </span>&#123;</div><div class="line">                <span class="keyword">return</span> CommonPatternHere(argument.dataSet,</div><div class="line">                    argument.call, argument.decrease,</div><div class="line">                    argument.beforeNext, after);</div><div class="line">            &#125;;</div><div class="line">        &#125;);</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可惜我当时脑子不太好使，不然应该可以写出一个不需要缓存参数的版本。现在……脑子更不好使了，就当没看见吧。从嵌套到平铺的一个关键问题就是没有<code>after</code>，因此首先对各个函数调用进行科里化，延缓其对<code>after</code>的需求。最后，第三部分包含了套参数和组装的过程：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> CurryList()</div><div class="line">.Call(self._actions.move,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">move, finished</span>) </span>&#123;</div><div class="line">        Move(move.x1, move.y1, move.x2, move.y2, finished);</div><div class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;  <span class="comment">// I want pointer!</span></div><div class="line">        <span class="keyword">return</span> --self._remain.move;</div><div class="line">    &#125;, afterMove)</div><div class="line">.Call(self._actions.substitute,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">sub, finished</span>) </span>&#123;</div><div class="line">        Substitute(sub.x, sub.y, sub.number, finished);</div><div class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> --self._remain.substitute;</div><div class="line">    &#125;)</div><div class="line">.Call(self._actions.advent,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">advent, finished</span>) </span>&#123;</div><div class="line">        Advent(advent.x, advent.y, advent.number, finished);</div><div class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> --self._remain.advent;</div><div class="line">    &#125;, afterAdvent)</div><div class="line">.List().reduceRight(</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">after, previous</span>) </span>&#123; <span class="keyword">return</span> previous(after); &#125;,</div><div class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">"All done for this turn."</span>); &#125;)();</div></pre></td></tr></table></figure>
<p>使用<code>reduceRight</code>就可以按照自然顺序进行链式调用了（“在<code>CurryList</code>里不能处理吗？”“听不见听不见……”），顺便你会发现在接口层当中预留的<code>finished</code>函数其实就是上面第一部分中定义的，基本逻辑是给计数器减一，到0就调用<code>after</code>开始下一阶段。<code>afterXXX</code>也都被安排到了合理的位置上。</p>
<p>顺便一说写到<code>reduceRight</code>的时候我突然想起对IE的兼容性问题，于是万念俱灰的用IE11打开这个页面，没想到在去掉了默认参数和<code>Array.fill</code>以后居然正确的运行了！这一刻我的喜悦和程序刚刚跑通时相比有增无减。</p>
<hr>
<p>下一个抽象层次是<code>Grid</code>，它代表一张棋盘。在这里，我们终于要迎来喜闻乐见的游戏逻辑，而在此之前，问自己一个问题：如何避免把同样的代码写四遍？官方实现用的方法非常精巧，而我就笨拙得多了。进入主题前先看看内部数据结构：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Grid</span>(<span class="params">size</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">this</span>._grid = <span class="keyword">new</span> <span class="built_in">Array</span>(size);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>._grid.length; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">this</span>._grid[i] = <span class="keyword">new</span> <span class="built_in">Array</span>(size);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="keyword">this</span>._grid[i].length; j++)</div><div class="line">            <span class="keyword">this</span>._grid[i][j] = <span class="number">0</span>;  <span class="comment">// 0 means no number here.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个简单的二维数组，因为去掉了<code>Array.fill</code>所以显得有些啰嗦，不过倒是有点像我上一篇文章里说的，有点C程序的感觉了，只是现在……我谢天谢地它不是用C写的。跳过生成随机数字的函数，首先来看<code>Slide</code>的第一部分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// `direction`: 0 =&gt; up, 1 =&gt; right, 2 =&gt; down, 3 =&gt; left.</span></div><div class="line"><span class="keyword">this</span>.Slide = <span class="function"><span class="keyword">function</span>(<span class="params">direction, turn</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="comment">// Slide `numbers` toward numbers[0].</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">SlideVector</span>(<span class="params">numbers, move, merge</span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">var</span> merged = <span class="keyword">new</span> <span class="built_in">Array</span>(size);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; merged.length; i++)</div><div class="line">            merged[i] = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">var</span> changed = <span class="literal">false</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; size; i++)  <span class="comment">// First number stays.</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (numbers[i] === <span class="number">0</span>)</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> j = i - <span class="number">1</span>; j &gt;= <span class="number">0</span>; j--)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (merged[j])  <span class="comment">// Merged number will not be modified again.</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">if</span> (j + <span class="number">1</span> !== i)</div><div class="line">                    &#123;</div><div class="line">                        changed = <span class="literal">true</span>;</div><div class="line">                        move(i, j + <span class="number">1</span>);</div><div class="line">                        numbers[j + <span class="number">1</span>] = numbers[i];</div><div class="line">                        numbers[i] = <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (numbers[j] !== <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">if</span> (numbers[j] === numbers[i])  <span class="comment">// Merge same numbers.</span></div><div class="line">                    &#123;</div><div class="line">                        changed = <span class="literal">true</span>;</div><div class="line">                        merge(i, j, numbers[i]);</div><div class="line">                        merged[j] = <span class="literal">true</span>;</div><div class="line">                        numbers[j] += numbers[i];</div><div class="line">                        numbers[i] = <span class="number">0</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">else</span>  <span class="comment">// Move to neighbour.</span></div><div class="line">                    &#123;</div><div class="line">                        <span class="keyword">if</span> (j + <span class="number">1</span> !== i)</div><div class="line">                        &#123;</div><div class="line">                            changed = <span class="literal">true</span>;</div><div class="line">                            move(i, j + <span class="number">1</span>);</div><div class="line">                            numbers[j + <span class="number">1</span>] = numbers[i];</div><div class="line">                            numbers[i] = <span class="number">0</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (j === <span class="number">0</span>)  <span class="comment">// Stop moving on the edge.</span></div><div class="line">                &#123;</div><div class="line">                    changed = <span class="literal">true</span>;</div><div class="line">                    move(i, <span class="number">0</span>);</div><div class="line">                    numbers[<span class="number">0</span>] = numbers[i];</div><div class="line">                    numbers[i] = <span class="number">0</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> changed;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>这个子函数的功能是把一列数向着它的首元素方向“滑动”，逻辑基本就是上文的复述。这里主要注意的是移动数字以后对于“是否改变”的判定，要把“原地移动”的情况排除掉。想来这个函数功能的简单出乎各位看官的预料，那么更多的功能显然交给调用方了。大家等不及看四遍重复的代码了吧？然而，还真没有……</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> UP = <span class="number">0</span>, RIGHT = <span class="number">1</span>, DOWN = <span class="number">2</span>, LEFT = <span class="number">3</span>;</div><div class="line"><span class="keyword">var</span> changed = <span class="literal">false</span>;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> first = <span class="number">0</span>; first &lt; size; first++)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">var</span> numbers = <span class="keyword">new</span> <span class="built_in">Array</span>(size), iX = <span class="keyword">new</span> <span class="built_in">Array</span>(size),</div><div class="line">        iY = <span class="keyword">new</span> <span class="built_in">Array</span>(size);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> second = <span class="number">0</span>; second &lt; size; second++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> sec = direction === UP || direction === LEFT ? second :</div><div class="line">            size - second - <span class="number">1</span>;</div><div class="line">        <span class="comment">// I hate 80 ruler.</span></div><div class="line">        iX[second] =</div><div class="line">            direction === UP || direction === DOWN ? first : sec;</div><div class="line">        iY[second] =</div><div class="line">            direction === UP || direction === DOWN ? sec : first;</div><div class="line">        <span class="comment">// console.log(second + " " + StringP(iX[second], iY[second]));</span></div><div class="line">        numbers[second] = self._grid[iX[second]][iY[second]];</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// It's a little breaking my rule to put left brace on the same line</span></div><div class="line">    <span class="comment">// of previous code, but it seems too ugly otherwise.</span></div><div class="line">    <span class="keyword">var</span> c = SlideVector(numbers, <span class="function"><span class="keyword">function</span>(<span class="params">from, to</span>) </span>&#123;</div><div class="line">        turn.Move(iX[<span class="keyword">from</span>], iY[<span class="keyword">from</span>], iX[to], iY[to]);</div><div class="line">        self._grid[iX[to]][iY[to]] = self._grid[iX[<span class="keyword">from</span>]][iY[<span class="keyword">from</span>]];</div><div class="line">        self._grid[iX[<span class="keyword">from</span>]][iY[<span class="keyword">from</span>]] = <span class="number">0</span>;</div><div class="line">    &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">from, to, number</span>) </span>&#123;</div><div class="line">        turn.Merge(iX[<span class="keyword">from</span>], iY[<span class="keyword">from</span>], iX[to], iY[to], number);</div><div class="line">        self._grid[iX[to]][iY[to]] += self._grid[iX[<span class="keyword">from</span>]][iY[<span class="keyword">from</span>]];</div><div class="line">        self._grid[iX[<span class="keyword">from</span>]][iY[<span class="keyword">from</span>]] = <span class="number">0</span>;</div><div class="line">    &#125;);</div><div class="line">    changed = c ? <span class="literal">true</span> : changed;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (changed)</div><div class="line">    self.AddRandom(turn);</div><div class="line"><span class="keyword">return</span> changed;</div></pre></td></tr></table></figure>
<p>在对不同的情况把<code>numbers</code>当中的数排好顺序的同时，填好<code>iX</code>和<code>iY</code>两个数组，作为两个平行数组分别储存<code>numbers</code>中各元素的x和y坐标。在<code>SlideVector</code>中使用的<code>move</code>和<code>merge</code>也在此处被包装好，提供足够的信息去调用下层的接口。在此之后，<code>Grid</code>当中还有一个判断游戏是否结束的函数，主要检查两件事：还有没有空位，以及有没有相邻的相同元素，符合任何一个条件都还是活局，否则就死了。</p>
<p>以上两个层次作为这篇代码的精华，也是最华而不实的部分……如果把其中为了形式美观做的抽象（科里化、<code>SlideVector</code>子函数等）都去掉，再把所有的左大括号拿到上一行去（做梦吧），这篇代码也许就只剩300多行了。</p>
<hr>
<p>接下来是组装前的最后一个步骤：画界面层。在这里我就遇到了之前给自己挖的坑：接口层留的三个基本接口实在是太“纯粹”了，它们都是无状态的接口，不能在两次调用之间留存任何信息。而偏偏图形层就需要一些信息：比如说前一个调用创建了一个数字，后一个调用去移动它的时候，得先在DOM树上把它找回来。之前采用id来标识，就会遇到两个数字移动到同一个位置的尴尬局面。最后先妥协了一下，用了全局变量，之后尽量把它改过来，先凑合着看吧。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Display Part.</span></div><div class="line"><span class="comment">// This is the base of a more complicated implementation of interfaces.</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DisplayInitialize</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">var</span> container = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">    container.id = <span class="string">"board-tiles-container"</span>;</div><div class="line">    container.style.width = container.style.height = <span class="string">"450px"</span>;</div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"board-container"</span>).appendChild(container);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> searchTable = <span class="keyword">new</span> <span class="built_in">Object</span>, registryTable = <span class="keyword">new</span> <span class="built_in">Object</span>, deadQueue = <span class="keyword">new</span> <span class="built_in">Array</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DisplayAdvent</span>(<span class="params">x, y, number, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">var</span> tile = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</div><div class="line">    tile.innerText = number;</div><div class="line">    tile.classList.add(<span class="string">"board-tile"</span>);</div><div class="line">    tile.style.transition = <span class="string">"all 0.05s"</span>;</div><div class="line">    tile.style.width = tile.style.height = <span class="number">0</span>;</div><div class="line">    tile.style.lineHeight = <span class="string">"100px"</span>;</div><div class="line">    tile.style.fontSize = <span class="number">0</span>;</div><div class="line">    tile.style.margin = <span class="string">"50px"</span>;</div><div class="line">    tile.style.top  = (y * <span class="number">110</span> + <span class="number">10</span>) + <span class="string">"px"</span>;</div><div class="line">    tile.style.left = (x * <span class="number">110</span> + <span class="number">10</span>) + <span class="string">"px"</span>;</div><div class="line">    <span class="built_in">document</span>.getElementById(<span class="string">"board-tiles-container"</span>).appendChild(tile);</div><div class="line">    searchTable[StringP(x, y)] = tile;</div><div class="line"></div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        tile.style.width = tile.style.height = <span class="string">"100px"</span>;</div><div class="line">        tile.style.fontSize = <span class="string">"20px"</span>;</div><div class="line">        tile.style.margin = <span class="string">""</span>;</div><div class="line">    &#125;, <span class="number">0</span>);</div><div class="line">    OnceListener(tile, finished);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DisplayMove</span>(<span class="params">x, y, newX, newY, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">var</span> tile = searchTable[StringP(x, y)];</div><div class="line">    tile.style.transition = <span class="string">"all 0.2s"</span>;</div><div class="line">    tile.style.top  = (newY * <span class="number">110</span> + <span class="number">10</span>) + <span class="string">"px"</span>;</div><div class="line">    tile.style.left = (newX * <span class="number">110</span> + <span class="number">10</span>) + <span class="string">"px"</span>;</div><div class="line">    <span class="comment">// There's no need to worry about overriding.</span></div><div class="line">    <span class="comment">// Any override tile will be override again by substitution.</span></div><div class="line">    <span class="comment">// So any of them survives will be okay.</span></div><div class="line">    <span class="keyword">if</span> (registryTable[StringP(newX, newY)] !== <span class="literal">undefined</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> dead = registryTable[StringP(newX, newY)];</div><div class="line">        deadQueue.push(dead);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">delete</span> searchTable[StringP(x, y)];</div><div class="line">    registryTable[StringP(newX, newY)] = tile;</div><div class="line">    OnceListener(tile, finished);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DisplayAfterMove</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">while</span> (deadQueue.length &gt; <span class="number">0</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">var</span> dead = deadQueue.pop();</div><div class="line">        dead.parentElement.removeChild(dead);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">Object</span>.keys(registryTable).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">pos</span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (searchTable[pos] !== <span class="literal">undefined</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">var</span> dead = searchTable[pos];</div><div class="line">            dead.parentElement.removeChild(dead);</div><div class="line">        &#125;</div><div class="line">        searchTable[pos] = registryTable[pos];</div><div class="line">    &#125;);</div><div class="line">    registryTable = <span class="keyword">new</span> <span class="built_in">Object</span>;</div><div class="line">    <span class="comment">// console.log(searchTable);</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">DisplaySubstitute</span>(<span class="params">x, y, num, finished</span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">var</span> tile = searchTable[StringP(x, y)];</div><div class="line">    tile.innerText = num;</div><div class="line">    tile.style.transition = <span class="string">"all 0.1s"</span>;</div><div class="line">    tile.style.width = tile.style.height = tile.style.lineHeight = <span class="string">"110px"</span>;</div><div class="line">    tile.style.fontSize = <span class="string">"22px"</span>;</div><div class="line">    tile.style.margin = <span class="string">"-5px"</span>;</div><div class="line">    OnceListener(tile, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        tile.style.width = tile.style.height = tile.style.lineHeight = <span class="string">"100px"</span>;</div><div class="line">        tile.style.fontSize = <span class="string">"20px"</span>;</div><div class="line">        tile.style.margin = <span class="string">""</span>;</div><div class="line">        OnceListener(tile, finished);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中还有大量的常数，之后会抽到配置当中去。这里的三个全局（列）表都是为<code>DisplayMove</code>服务的，在一个<code>Turn</code>的周期内，所有的数字以如下的方式在这三个表中流窜：</p>
<ul>
<li>最初，所有数字都在<code>searchTable</code>里；</li>
<li>移动阶段，每个数字移动的同时，把自己注册到<code>registryTable</code>的对应位置上，如果遇到两个数字都移动且终点相同的情况则后来者会覆盖先到者，并把它转移到<code>deadQueue</code>里面去。（这里谁去谁留没有区别，因为这种情况之后一定会对应一个替换步骤，所以……谁都活不了）</li>
<li>移动结束阶段，首先<code>deadQueue</code>里的数字被清除掉，然后<code>registryTable</code>里的数字转移回<code>searchTable</code>里，如果转移回来的时候发现对应的格子里已经有数字了，说明这是一个数字移动到另一个静止数字位置上的情况，则静止数字被清除，由新来的数字填补。</li>
<li>接下来的时间里，大家都一直呆在<code>searchTable</code>里，直到下一个移动阶段到来。</li>
</ul>
<p>这里的一个要点就是一定要到移动结束阶段（对应于<code>DisplayAfterMove</code>函数）才可以开始清理重叠的数字，对于静止的数字，这是为了防止格子上的数字突然消失吓到小朋友；对于两个数字都移动的情况，别忘了它们身上还有一个<code>finished</code>呢，这个函数的调用时机是<code>transitionend</code>事件（比手动<code>setTimeout</code>高端多了），如果提前清掉了移动阶段就再也结束不了了。这几个方法的结尾都有一个<code>OnceListener</code>函数的调用，这个函数会给元素添加一个绑定在<code>transitionend</code>事件上的一次性回调函数，触发了就被移除，避免与下一个<code>finished</code>弄混。</p>
<p>此外，<code>DisplayAdvent</code>要实现的动画效果是从中心一个点开始扩大，要把设置其样式为正常值的部分放在<code>setTimeout(..., 0)</code>的里面，这样可以避免与前面的DOM操作合并，动画没了是小事，触发不了<code>transitionend</code>可就坏了。</p>
<p>最后，<code>DisplaySubstitute</code>（感谢这个程序终于让我记熟了这个词的拼写）的效果是先变大一圈再变小。你问我为什么不写成链式的了？懒啊！</p>
<hr>
<p>好了，最后终于来到了主函数部分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Main Part.</span></div><div class="line"><span class="comment">// The main game loop and entry point.</span></div><div class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    DisplayInitialize();</div><div class="line">    <span class="keyword">var</span> turn = <span class="keyword">new</span> Turn();</div><div class="line">    <span class="keyword">var</span> grid = <span class="keyword">new</span> Grid(<span class="number">4</span>);</div><div class="line">    grid.AddRandom(turn);</div><div class="line">    grid.AddRandom(turn);</div><div class="line">    turn.Trigger();</div><div class="line">    <span class="comment">// console.log(grid);</span></div><div class="line"></div><div class="line">    <span class="keyword">var</span> animating = <span class="literal">false</span>, over = <span class="literal">false</span>;</div><div class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">"keypress"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="comment">// Disable key press during animation.</span></div><div class="line">        <span class="keyword">if</span> (animating || over)</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        <span class="keyword">var</span> map = &#123;<span class="attr">w</span>: <span class="number">0</span>, <span class="attr">d</span>: <span class="number">1</span>, <span class="attr">s</span>: <span class="number">2</span>, <span class="attr">a</span>: <span class="number">3</span>&#125;;</div><div class="line">        <span class="keyword">if</span> (e.key <span class="keyword">in</span> map)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (grid.Slide(map[e.key], turn))</div><div class="line">            &#123;</div><div class="line">                animating = <span class="literal">true</span>;</div><div class="line">                turn.Trigger(DisplayAfterMove, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">                    animating = <span class="literal">false</span>;</div><div class="line">                    <span class="built_in">console</span>.log(StringG(grid));</div><div class="line">                    <span class="keyword">if</span> (grid.Over())</div><div class="line">                    &#123;</div><div class="line">                        <span class="built_in">console</span>.log(<span class="string">"Game Over"</span>);</div><div class="line">                        over = <span class="literal">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// console.log(searchTable);</span></div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>大部分逻辑都一目了然了。其中<code>animating</code>是为了在动画过程中屏蔽按键（虽然除非你是故意瞎滑也不可能那么快做出判断），而“Game Over”的界面不仅仅是没有加入到真正的页面上，甚至没有完成其正确性测试……每一局都因为各种奇奇怪怪的原因流产了……最后一次是在IE11上，我把它的console调出来看看输出，然后键盘操作就不好使了……什么龟。</p>
<hr>
<p>感觉就像讲了一生的故事一样，这份代码经过几次推倒重来，虽然最终版只用了小半天时间，但算是近很长一段时间以来唯一一个算是完整的作品。当然啦，只能叫“算是”，毕竟这份代码的最终目的——帮我玩出4096，还一点都没开始呢。</p>
<p>项目地址：<a href="https://github.com/oziroe/try-2048" target="_blank" rel="external">try-2048</a>，欢迎丢星星。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://oziroe.github.io/2017/08/01/多年后终于（开始）完成的夙愿——2048/" data-id="cj69deaya000ajfsnfbceey8f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/2048/">2048</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Try2048/">Try2048</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/javascript/">javascript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/函数式编程/">函数式编程</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/08/04/狂想症中毒患者的生日篇章/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          狂想症中毒患者的生日篇章
        
      </div>
    </a>
  
  
    <a href="/2017/07/30/突然回忆的过往之事/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">突然回忆的过往之事</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/2048/" style="font-size: 10px;">2048</a> <a href="/tags/4b/" style="font-size: 17.5px;">4b</a> <a href="/tags/Bitabase/" style="font-size: 12.5px;">Bitabase</a> <a href="/tags/Blue-Fat/" style="font-size: 10px;">Blue Fat</a> <a href="/tags/Bug/" style="font-size: 10px;">Bug</a> <a href="/tags/C/" style="font-size: 17.5px;">C</a> <a href="/tags/C/" style="font-size: 10px;">C++</a> <a href="/tags/C-11/" style="font-size: 10px;">C++11</a> <a href="/tags/Cacoa/" style="font-size: 10px;">Cacoa</a> <a href="/tags/DLL/" style="font-size: 10px;">DLL</a> <a href="/tags/Daze/" style="font-size: 10px;">Daze</a> <a href="/tags/Dev-C/" style="font-size: 10px;">Dev-C++</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/Lex/" style="font-size: 10px;">Lex</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/Minecraft/" style="font-size: 10px;">Minecraft</a> <a href="/tags/Objective-C/" style="font-size: 10px;">Objective-C</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Ruby/" style="font-size: 12.5px;">Ruby</a> <a href="/tags/STL/" style="font-size: 10px;">STL</a> <a href="/tags/Swift/" style="font-size: 10px;">Swift</a> <a href="/tags/Try2048/" style="font-size: 12.5px;">Try2048</a> <a href="/tags/Visual-Studio/" style="font-size: 10px;">Visual Studio</a> <a href="/tags/Win32/" style="font-size: 10px;">Win32</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/Yacc/" style="font-size: 10px;">Yacc</a> <a href="/tags/css/" style="font-size: 10px;">css</a> <a href="/tags/ejs/" style="font-size: 10px;">ejs</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/lex/" style="font-size: 10px;">lex</a> <a href="/tags/lxml/" style="font-size: 10px;">lxml</a> <a href="/tags/macOS/" style="font-size: 10px;">macOS</a> <a href="/tags/oz/" style="font-size: 12.5px;">oz</a> <a href="/tags/oziroe-github-io/" style="font-size: 10px;">oziroe.github.io</a> <a href="/tags/pbrt/" style="font-size: 10px;">pbrt</a> <a href="/tags/pip/" style="font-size: 10px;">pip</a> <a href="/tags/stylus/" style="font-size: 10px;">stylus</a> <a href="/tags/typora/" style="font-size: 10px;">typora</a> <a href="/tags/yacc/" style="font-size: 10px;">yacc</a> <a href="/tags/代数系统/" style="font-size: 10px;">代数系统</a> <a href="/tags/做梦/" style="font-size: 12.5px;">做梦</a> <a href="/tags/函数式编程/" style="font-size: 10px;">函数式编程</a> <a href="/tags/图/" style="font-size: 10px;">图</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/破事水/" style="font-size: 17.5px;">破事水</a> <a href="/tags/离散数学/" style="font-size: 10px;">离散数学</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/设计模式/" style="font-size: 10px;">设计模式</a> <a href="/tags/造轮子/" style="font-size: 10px;">造轮子</a> <a href="/tags/随笔/" style="font-size: 20px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">2017年8月</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">2017年7月</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">2017年6月</a><span class="archive-list-count">12</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/08/12/使用Ruby与Lex-Yacc一起构建编译器的第一步/">使用Ruby与Lex/Yacc一起构建编译器的第一步</a>
          </li>
        
          <li>
            <a href="/2017/08/07/有关于Blue-Fat的构想和计划/">有关于Blue Fat的构想和计划</a>
          </li>
        
          <li>
            <a href="/2017/08/07/急需一个新的对梦境的理解/">急需一个新的对梦境的理解</a>
          </li>
        
          <li>
            <a href="/2017/08/04/狂想症中毒患者的生日篇章/">狂想症中毒患者的生日篇章</a>
          </li>
        
          <li>
            <a href="/2017/08/01/多年后终于（开始）完成的夙愿——2048/">多年后终于（开始）完成的夙愿——2048</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 oziroe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>